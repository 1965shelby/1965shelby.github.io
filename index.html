/**
 * Handle POST requests from the form
 */
function doPost(e) {
  try {
    // Parse the incoming JSON data
    const data = JSON.parse(e.postData.contents);

    // 1. Verify reCAPTCHA
    const secretKey = 'YOUR_SECRET_KEY'; // Replace with your actual Secret Key
    const token = data.token;
    const recaptchaUrl = 'https://www.google.com/recaptcha/api/siteverify';
    const recaptchaParams = {
      method: 'post',
      payload: {
        secret: secretKey,
        response: token
      }
    };
    const recaptchaResponse = UrlFetchApp.fetch(recaptchaUrl, recaptchaParams);
    const recaptchaResult = JSON.parse(recaptchaResponse.getContentText());

    // Check if reCAPTCHA was successful and the score is acceptable
    if (!recaptchaResult.success || (recaptchaResult.score && recaptchaResult.score < 0.5)) {
      return makeJsonResponse({
        status: 'error',
        message: 'reCAPTCHA verification failed. Please try again.'
      });
    }

    // 2. Validate required fields
    const requiredFields = ['firstName', 'lastName', 'email', 'phone', 'state', 'age', 'insuranceType', 'coverageAmount'];
    for (let field of requiredFields) {
      if (!data[field] || data[field].trim() === '') {
        return makeJsonResponse({
          status: 'error',
          message: `Missing required field: ${field}`
        });
      }
    }

    // 3. Append data to Google Sheet
    const sheet = SpreadsheetApp.openById('YOUR_SPREADSHEET_ID').getSheetByName('Sheet1'); // Replace with your Sheet ID and Sheet Name
    const timestamp = new Date().toISOString();

    const newRow = [
      timestamp,
      data.firstName,
      data.lastName,
      data.email,
      data.phone,
      data.state,
      data.age,
      data.insuranceType,
      data.coverageAmount
    ];

    sheet.appendRow(newRow);

    // 4. Respond with success
    return makeJsonResponse({
      status: 'success',
      message: 'Data successfully recorded.'
    });

  } catch (error) {
    // Handle unexpected errors
    return makeJsonResponse({
      status: 'error',
      message: 'Server error. Please try again later.'
    });
  }
}

/**
 * Utility function to create JSON responses
 */
function makeJsonResponse(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}
